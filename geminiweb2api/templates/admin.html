<!DOCTYPE html>
<html lang="zh-CN" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†æ§åˆ¶å° - GeminiWeb2API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .animate-slide-up {
            animation: slide-up .3s ease-out
        }

        .tab-btn {
            transition: all .2s ease
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: color .2s, background-color .2s;
            height: 2rem;
            width: 2rem;
        }

        .btn-icon:hover {
            background-color: hsl(0 0% 96.1%);
            color: hsl(0 0% 9%)
        }

        .cfg-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(0 0% 45.1%);
            margin-bottom: 0.5rem;
            display: block;
        }

        .cfg-input {
            display: flex;
            height: 2.25rem;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid hsl(0 0% 89%);
            background-color: hsl(0 0% 100%);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .cfg-input:focus {
            outline: none;
            border-color: hsl(0 0% 3.9%);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { border: "hsl(0 0% 89%)", input: "hsl(0 0% 89%)", ring: "hsl(0 0% 3.9%)", background: "hsl(0 0% 100%)", foreground: "hsl(0 0% 3.9%)", primary: { DEFAULT: "hsl(0 0% 9%)", foreground: "hsl(0 0% 98%)" }, secondary: { DEFAULT: "hsl(0 0% 96.1%)", foreground: "hsl(0 0% 9%)" }, muted: { DEFAULT: "hsl(0 0% 96.1%)", foreground: "hsl(0 0% 45.1%)" }, accent: { DEFAULT: "hsl(0 0% 96.1%)", foreground: "hsl(0 0% 9%)" }, destructive: { DEFAULT: "hsl(0 84.2% 60.2%)", foreground: "hsl(0 0% 98%)" } } } } }
    </script>
</head>

<body class="h-full bg-background text-foreground antialiased">
    <!-- å¯¼èˆªæ  -->
    <header
        class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <span class="font-bold text-xl">GeminiWeb2API</span>
                <span class="text-xs text-gray-400">Gemini Web Proxy</span>
            </div>
            <div class="flex flex-1 items-center justify-end">
                <nav class="flex items-center gap-1">
                    <button onclick="logout()"
                        class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1">
                        <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        é€€å‡º
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab å¯¼èˆª -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('cookies')" id="tabCookies"
                    class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Cookie ç®¡ç†</button>
                <button onclick="switchTab('settings')" id="tabSettings"
                    class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Setting é…ç½®</button>
            </nav>
        </div>

        <!-- Cookie ç®¡ç†é¢æ¿ -->
        <div id="panelCookies">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-4 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Cookie æ€»æ•°</p>
                    <h3 class="text-xl font-bold" id="statTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Cookie æ­£å¸¸</p>
                    <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Cookie æœªä½¿ç”¨</p>
                    <h3 class="text-xl font-bold text-gray-500" id="statUnused">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Cookie å¤±æ•ˆ</p>
                    <h3 class="text-xl font-bold text-red-500" id="statFailed">-</h3>
                </div>
            </div>

            <!-- Cookie åˆ—è¡¨ -->
            <div class="rounded-lg border border-border bg-background">
                <!-- å·¥å…·æ  -->
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <div class="flex items-center gap-3 flex-1">
                        <select id="filterStatus" onchange="filterCookies()"
                            class="h-8 px-2 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="æ­£å¸¸">æ­£å¸¸</option>
                            <option value="å¤±æ•ˆ">å¤±æ•ˆ</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="openAddModal()"
                            class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            <span class="text-sm font-medium">æ–°å¢</span>
                        </button>
                    </div>
                </div>

                <!-- è¡¨æ ¼ -->
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm table-fixed">
                        <thead>
                            <tr class="border-b border-border">
                                <th
                                    class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-48">
                                    Cookie ID</th>
                                <th
                                    class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">
                                    çŠ¶æ€</th>
                                <th
                                    class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">
                                    ä½¿ç”¨æ¬¡æ•°</th>
                                <th
                                    class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-40">
                                    å¤‡æ³¨</th>
                                <th
                                    class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-32">
                                    åˆ›å»ºæ—¶é—´</th>
                                <th
                                    class="h-10 px-3 text-center align-middle text-sm font-medium text-muted-foreground w-28">
                                    æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cookieTableBody" class="divide-y divide-border">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12">
                    <svg class="h-10 w-10 text-muted-foreground/50 mb-3" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M9 9h6v6H9z" />
                    </svg>
                    <p class="text-sm text-muted-foreground">æš‚æ— æ•°æ®</p>
                </div>
            </div>
        </div>

        <!-- Setting é…ç½®é¢æ¿ -->
        <div id="panelSettings" class="hidden">
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">å…¨å±€é…ç½®</h2>
                    <button onclick="saveSettings()"
                        class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-black hover:text-white h-9 px-4 transition-colors">ä¿å­˜é…ç½®</button>
                </div>
                <div class="grid gap-4 lg:grid-cols-3">
                    <!-- ç³»ç»Ÿè®¾ç½® -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">ç³»ç»Ÿè®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">ç™»å½•è´¦æˆ·</label>
                                <input id="cfgAdminUser" class="cfg-input" placeholder="admin">
                            </div>
                            <div>
                                <label class="cfg-label">ç™»å½•å¯†ç </label>
                                <input id="cfgAdminPass" type="password" class="cfg-input" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                            </div>
                        </div>
                    </div>

                    <!-- åª’ä½“è®¾ç½® -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">åª’ä½“è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">å›¾ç‰‡æ¨¡å¼</label>
                                <select id="cfgImageMode" class="cfg-input">
                                    <option value="url">URL é“¾æ¥</option>
                                    <option value="base64">Base64</option>
                                </select>
                            </div>
                            <div>
                                <label class="cfg-label">æœåŠ¡ç½‘å€</label>
                                <input id="cfgBaseUrl" class="cfg-input" placeholder="http://localhost:8001">
                            </div>
                            <div>
                                <label class="cfg-label">å›¾ç‰‡ç¼“å­˜ä¸Šé™ (MB)</label>
                                <input id="cfgImageCacheMaxSize" type="number" class="cfg-input" placeholder="512">
                            </div>
                        </div>
                    </div>

                    <!-- ç¼“å­˜ç®¡ç† -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">ç¼“å­˜ç®¡ç†</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">å½“å‰å›¾ç‰‡ç¼“å­˜</label>
                                <div class="flex gap-2">
                                    <input id="imageCacheSize" readonly class="cfg-input bg-muted flex-1"
                                        placeholder="0 MB">
                                    <button onclick="clearCache()"
                                        class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-red-600 hover:text-white h-9 w-9 p-0 transition-colors"
                                        title="æ¸…é™¤ç¼“å­˜">
                                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gemini é…ç½®åŒºåŸŸ -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Gemini é…ç½®</h2>
                </div>
                <div class="grid gap-4 lg:grid-cols-3">
                    <!-- API è®¾ç½® -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">API è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">API Key</label>
                                <input id="cfgApiKey" class="cfg-input" placeholder="ç•™ç©ºåˆ™ä¸éªŒè¯">
                            </div>
                        </div>
                    </div>

                    <!-- ä»£ç†è®¾ç½® -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">ä»£ç†è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">Proxy URL</label>
                                <input id="cfgProxyUrl" class="cfg-input" placeholder="http://127.0.0.1:7890">
                            </div>
                        </div>
                    </div>

                    <!-- è¶…æ—¶è®¾ç½® -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">è¶…æ—¶è®¾ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="cfg-label">è¯·æ±‚è¶…æ—¶ (ç§’)</label>
                                <input id="cfgTimeout" type="number" class="cfg-input" placeholder="120">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ’ä»¶è¿æ¥åŒºåŸŸ -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">ğŸ”Œ æ’ä»¶è¿æ¥</h2>
                </div>
                <div class="rounded-lg border border-border bg-background p-6">
                    <p class="text-sm text-muted-foreground mb-4">ä½¿ç”¨æ²¹çŒ´è„šæœ¬è‡ªåŠ¨åŒæ­¥ Cookieã€‚å®‰è£…è„šæœ¬ååœ¨ Gemini é¡µé¢é…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
                    <div class="space-y-4">
                        <div>
                            <label class="cfg-label">æœåŠ¡å™¨åœ°å€</label>
                            <div class="flex gap-2">
                                <input id="pluginServerUrl" readonly class="cfg-input bg-muted flex-1">
                                <button onclick="copyToClipboard(document.getElementById('pluginServerUrl').value)"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-primary hover:text-primary-foreground h-9 px-3 transition-colors">
                                    å¤åˆ¶
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="cfg-label">è¿æ¥ Token</label>
                            <div class="flex gap-2">
                                <input id="pluginToken" readonly class="cfg-input bg-muted flex-1">
                                <button onclick="regeneratePluginToken()"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-yellow-500 hover:text-white h-9 px-3 transition-colors"
                                    title="é‡æ–°ç”Ÿæˆ Token">
                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                        </path>
                                    </svg>
                                </button>
                                <button onclick="copyToClipboard(document.getElementById('pluginToken').value)"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-primary hover:text-primary-foreground h-9 px-3 transition-colors">
                                    å¤åˆ¶
                                </button>
                            </div>
                        </div>
                        <div class="pt-2 border-t border-border">
                            <a href="/webapi-cookie-sync.user.js" target="_blank"
                                class="inline-flex items-center text-sm text-primary hover:underline">
                                ğŸ“¥ ä¸‹è½½æ²¹çŒ´è„šæœ¬
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ  Cookie æ¨¡æ€æ¡† -->
    <div id="addModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div
            class="bg-background rounded-lg border border-border w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">æ·»åŠ  Cookie</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-muted-foreground">å®Œæ•´ Cookie å­—ç¬¦ä¸²</label>
                    <textarea id="addCookieInput" rows="6"
                        placeholder="ç²˜è´´ä»æµè§ˆå™¨å¤åˆ¶çš„å®Œæ•´Cookieå­—ç¬¦ä¸²...&#10;&#10;è·å–æ–¹æ³•ï¼š&#10;1. ç™»å½• https://gemini.google.com&#10;2. F12 æ‰“å¼€å¼€å‘è€…å·¥å…· -> Application -> Cookies&#10;3. å³é”®ä»»æ„cookie -> Copy all as Header String"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring resize-none font-mono"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-muted-foreground">å¤‡æ³¨ (å¯é€‰)</label>
                    <input id="addNoteInput" class="cfg-input" placeholder="ä¾‹å¦‚: è´¦å·1">
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border bg-muted/30">
                <button onclick="closeAddModal()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                <button onclick="submitAddCookie()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let cookieData = [];
        const token = localStorage.getItem('adminToken');

        // æœªç™»å½•åˆ™è·³è½¬
        if (!token) location.href = '/admin';

        // API è¯·æ±‚
        async function api(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const resp = await fetch(url, { ...options, headers });
            if (resp.status === 401) { localStorage.removeItem('adminToken'); location.href = '/admin'; return null; }
            return resp.json();
        }

        // Toast æç¤º
        function showToast(m, t = 'info') {
            const d = document.createElement('div');
            const bc = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-primary' };
            d.className = `fixed bottom-4 right-4 ${bc[t] || bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`;
            d.textContent = m;
            document.body.appendChild(d);
            setTimeout(() => { d.style.opacity = '0'; d.style.transition = 'opacity .3s'; setTimeout(() => d.remove(), 300); }, 2000);
        }

        // Tab åˆ‡æ¢
        function switchTab(tab) {
            document.getElementById('panelCookies').classList.toggle('hidden', tab !== 'cookies');
            document.getElementById('panelSettings').classList.toggle('hidden', tab !== 'settings');
            document.getElementById('tabCookies').classList.toggle('border-primary', tab === 'cookies');
            document.getElementById('tabCookies').classList.toggle('border-transparent', tab !== 'cookies');
            document.getElementById('tabSettings').classList.toggle('border-primary', tab === 'settings');
            document.getElementById('tabSettings').classList.toggle('border-transparent', tab !== 'settings');
            if (tab === 'settings') {
                loadSettings();
                // Set plugin server URL
                document.getElementById('pluginServerUrl').value = window.location.origin + '/api/plugin/update-cookie';
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (!text) { showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error'); return; }
            navigator.clipboard.writeText(text).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // åŠ è½½ Cookie åˆ—è¡¨
        async function loadCookies() {
            const resp = await api('/api/cookies');
            if (!resp?.success) return;
            cookieData = resp.data || [];
            renderCookies();
            loadStats();
        }

        // åŠ è½½ç»Ÿè®¡
        async function loadStats() {
            const resp = await api('/api/stats');
            if (!resp?.success) return;
            document.getElementById('statTotal').textContent = resp.total;
            document.getElementById('statActive').textContent = resp.active;
            document.getElementById('statUnused').textContent = resp.unused;
            document.getElementById('statFailed').textContent = resp.failed;
        }

        // æ¸²æŸ“ Cookie è¡¨æ ¼
        function renderCookies() {
            const filter = document.getElementById('filterStatus').value;
            let filtered = cookieData;
            if (filter !== 'all') filtered = cookieData.filter(c => c.status === filter);

            const tbody = document.getElementById('cookieTableBody');
            const empty = document.getElementById('emptyState');

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            tbody.innerHTML = filtered.map(c => `
                <tr class="hover:bg-muted/50">
                    <td class="p-3 font-mono text-xs">${c.cookie_id.substring(0, 20)}...</td>
                    <td class="p-3"><span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${c.status === 'æ­£å¸¸' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${c.status}</span></td>
                    <td class="p-3">${c.use_count}</td>
                    <td class="p-3 text-muted-foreground text-xs">${c.note || '-'}</td>
                    <td class="p-3 text-xs text-muted-foreground">${c.created_time ? new Date(c.created_time * 1000).toLocaleString() : '-'}</td>
                    <td class="p-3 text-center">
                        <button onclick="deleteCookie('${c.cookie_id}')" class="btn-icon hover:text-destructive" title="åˆ é™¤">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterCookies() { renderCookies(); }

        // æ·»åŠ  Cookie
        function openAddModal() { document.getElementById('addModal').classList.remove('hidden'); document.getElementById('addCookieInput').value = ''; document.getElementById('addNoteInput').value = ''; }
        function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }

        async function submitAddCookie() {
            const cookieStr = document.getElementById('addCookieInput').value.trim();
            const note = document.getElementById('addNoteInput').value.trim();
            if (!cookieStr) { showToast('è¯·è¾“å…¥Cookie', 'error'); return; }
            const resp = await api('/api/cookies/add', { method: 'POST', body: JSON.stringify({ cookie_str: cookieStr, note: note }) });
            if (resp?.success) { showToast('æ·»åŠ æˆåŠŸ', 'success'); closeAddModal(); loadCookies(); } else { showToast(resp?.message || 'æ·»åŠ å¤±è´¥', 'error'); }
        }

        // åˆ é™¤ Cookie
        async function deleteCookie(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤ Cookie?')) return;
            const resp = await api(`/api/cookies/${id}`, { method: 'DELETE' });
            if (resp?.success) { showToast('åˆ é™¤æˆåŠŸ', 'success'); loadCookies(); } else { showToast(resp?.message || 'åˆ é™¤å¤±è´¥', 'error'); }
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            const resp = await api('/api/settings');
            if (!resp?.success) return;
            document.getElementById('cfgAdminUser').value = resp.data.admin_username || '';
            document.getElementById('cfgApiKey').value = resp.data.api_key || '';
            document.getElementById('cfgImageMode').value = resp.data.image_mode || 'url';
            document.getElementById('cfgBaseUrl').value = resp.data.base_url || '';
            document.getElementById('cfgImageCacheMaxSize').value = resp.data.image_cache_max_size || '';
            document.getElementById('cfgProxyUrl').value = resp.data.proxy_url || '';
            document.getElementById('cfgTimeout').value = resp.data.timeout || '';
            document.getElementById('pluginToken').value = resp.data.plugin_token || '';
            document.getElementById('imageCacheSize').value = resp.data.current_cache_size || '0 MB';
        }

        // é‡æ–°ç”Ÿæˆæ’ä»¶ Token
        async function regeneratePluginToken() {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆ Token å—ï¼Ÿæ—§ Token å°†å¤±æ•ˆï¼')) return;
            const resp = await api('/api/settings/plugin-token/regenerate', { method: 'POST' });
            if (resp?.success) {
                document.getElementById('pluginToken').value = resp.token;
                showToast('Token å·²é‡æ–°ç”Ÿæˆ', 'success');
            } else {
                showToast(resp?.message || 'æ“ä½œå¤±è´¥', 'error');
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const data = {
                admin_username: document.getElementById('cfgAdminUser').value.trim(),
                admin_password: document.getElementById('cfgAdminPass').value.trim(),
                api_key: document.getElementById('cfgApiKey').value.trim(),
                image_mode: document.getElementById('cfgImageMode').value,
                base_url: document.getElementById('cfgBaseUrl').value.trim(),
                image_cache_max_size: parseInt(document.getElementById('cfgImageCacheMaxSize').value) || 512,
                proxy_url: document.getElementById('cfgProxyUrl').value.trim(),
                timeout: parseInt(document.getElementById('cfgTimeout').value) || 120
            };
            const resp = await api('/api/settings', { method: 'POST', body: JSON.stringify(data) });
            if (resp?.success) { showToast('ä¿å­˜æˆåŠŸ', 'success'); } else { showToast(resp?.message || 'ä¿å­˜å¤±è´¥', 'error'); }
        }

        // æ¸…é™¤ç¼“å­˜
        async function clearCache() {
            if (!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰å›¾ç‰‡ç¼“å­˜?')) return;
            const resp = await api('/api/cache/clear', { method: 'POST' });
            if (resp?.success) { showToast('ç¼“å­˜å·²æ¸…é™¤', 'success'); loadSettings(); } else { showToast(resp?.message || 'æ¸…é™¤å¤±è´¥', 'error'); }
        }

        // é€€å‡ºç™»å½•
        function logout() { localStorage.removeItem('adminToken'); location.href = '/login'; }

        // åˆå§‹åŒ–
        loadCookies();
    </script>
</body>

</html>